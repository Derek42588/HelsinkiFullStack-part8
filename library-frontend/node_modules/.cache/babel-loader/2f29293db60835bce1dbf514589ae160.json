{"ast":null,"code":"import _slicedToArray from \"C:\\\\Users\\\\derek\\\\webdev\\\\HelsinkiFullStack\\\\part8\\\\library-frontend\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";\nvar _jsxFileName = \"C:\\\\Users\\\\derek\\\\webdev\\\\HelsinkiFullStack\\\\part8\\\\library-frontend\\\\src\\\\App.js\";\nimport React, { useState } from 'react';\nimport Authors from './components/Authors';\nimport Books from './components/Books';\nimport NewBook from './components/NewBook';\nimport LoginForm from './components/LoginForm';\nimport { useQuery, useMutation, useSubscription, useApolloClient } from 'react-apollo';\nimport { gql } from 'apollo-boost';\nconst ALL_AUTHORS = gql`\n{\n  allAuthors{\n    name\n    born\n    bookCount\n  }\n}\n`;\nconst USER = gql`\nquery {\n  me {\n    username\n    favorite\n  }\n}\n`;\nconst BOOK_ADDED = gql`\n  subscription {\n    bookAdded{\n      title\n      author {\n        name\n        born\n      }\n      published\n      genres\n      id\n    }\n  }\n`;\nconst ALL_BOOKS = gql`\n{\n  allBooks {\n    title\n    author {\n      name\n      born\n    }\n    published\n    genres\n    id\n  }\n}\n`;\nconst BOOKS_BY_GENRE = gql`\n  query genreBooks($genre: String!) {\n  allBooks(genre: $genre) {\n    title\n    author {\n      name\n      born\n    }\n    published\n    genres\n    id\n  }\n}\n\n`;\nconst CREATE_BOOK = gql`\n  mutation createBook($title: String!, $publishedInt: Int!, $author: String!, $genres: [String!]!) {\n    addBook(\n      title: $title,\n      published: $publishedInt,\n      author: $author,\n      genres: $genres\n    ) {\n      title\n      published\n      id\n      author {\n        name\n        born\n      }\n      genres\n    }\n  }\n`;\nconst LOGIN = gql`\n  mutation login($username: String!, $password: String!){\n    login(username: $username, password: $password){\n      value\n    }\n\n  }\n`;\nconst EDIT_AUTHOR = gql`\n  mutation editAuthor($name: String!, $born: Int!) {\n    editAuthor(name: $name, setBornTo: $born) {\n      name\n      born\n      id\n      bookCount\n    }\n  }\n`;\nconst MAKE_FAVORITE = gql`\n  mutation addFavorite($favorite: String!) {\n    addFavorite(favorite: $favorite) {\n      username\n      favorite\n    }\n  }\n`;\n\nconst App = () => {\n  const _useState = useState('authors'),\n        _useState2 = _slicedToArray(_useState, 2),\n        page = _useState2[0],\n        setPage = _useState2[1];\n\n  const _useState3 = useState(null),\n        _useState4 = _slicedToArray(_useState3, 2),\n        errorMessage = _useState4[0],\n        setErrorMessage = _useState4[1];\n\n  const _useState5 = useState(null),\n        _useState6 = _slicedToArray(_useState5, 2),\n        token = _useState6[0],\n        setToken = _useState6[1];\n\n  const _useState7 = useState({\n    g: \"\"\n  }),\n        _useState8 = _slicedToArray(_useState7, 2),\n        genreFilter = _useState8[0],\n        setGenreFilter = _useState8[1];\n\n  const authors = useQuery(ALL_AUTHORS);\n  const books = useQuery(ALL_BOOKS);\n  const user = useQuery(USER);\n  const filteredBooks = useQuery(BOOKS_BY_GENRE, {\n    variables: {\n      genre: genreFilter.g\n    }\n  });\n\n  const notify = message => {\n    setErrorMessage(message);\n    setTimeout(() => {\n      setErrorMessage(null);\n    }, 10000);\n  };\n\n  const client = useApolloClient();\n\n  const updateCacheWith = addedBook => {\n    const includedIn = (set, object) => set.map(p => p.id).includes(object.id);\n\n    const dInStoreAll = client.readQuery({\n      query: ALL_BOOKS\n    });\n    const dInStoreFiltered = client.readQuery({\n      query: BOOKS_BY_GENRE,\n      variables: {\n        genre: \"\"\n      }\n    });\n    console.log(dInStoreAll.allBooks);\n\n    if (!includedIn(dInStoreAll.allBooks, addedBook)) {\n      console.log(dInStoreAll.allBooks);\n      dInStoreAll.allBooks.push(addedBook);\n      dInStoreFiltered.allBooks.push(addedBook);\n      client.writeQuery({\n        query: ALL_BOOKS,\n        data: dInStoreAll\n      });\n      client.writeQuery({\n        query: BOOKS_BY_GENRE,\n        data: dInStoreFiltered\n      });\n    }\n  };\n\n  useSubscription(BOOK_ADDED, {\n    onSubscriptionData: ({\n      subscriptionData\n    }) => {\n      const addedBook = subscriptionData.data.bookAdded;\n      notify(`${addedBook.title} added`);\n      updateCacheWith(addedBook);\n    }\n  });\n\n  const handleError = error => {\n    setErrorMessage(error.graphQLErrors[0].message);\n    setTimeout(() => {\n      setErrorMessage(null);\n    }, 10000);\n  };\n\n  const logout = () => {\n    setToken(null);\n    localStorage.clear();\n    client.resetStore();\n  };\n\n  const errorNotification = () => errorMessage && React.createElement(\"div\", {\n    style: {\n      color: 'red'\n    },\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 191\n    },\n    __self: this\n  }, errorMessage);\n\n  const _useMutation = useMutation(CREATE_BOOK, {\n    onError: handleError,\n    update: (store, response) => {\n      updateCacheWith(response.data.addPerson);\n    }\n  }),\n        _useMutation2 = _slicedToArray(_useMutation, 1),\n        addBook = _useMutation2[0];\n\n  const _useMutation3 = useMutation(MAKE_FAVORITE, {\n    onError: handleError,\n    refetchQueries: [{\n      query: ALL_AUTHORS\n    }, {\n      query: ALL_BOOKS\n    }, {\n      query: USER\n    }]\n  }),\n        _useMutation4 = _slicedToArray(_useMutation3, 1),\n        makeFavorite = _useMutation4[0];\n\n  const _useMutation5 = useMutation(LOGIN, {\n    onError: handleError,\n    update: (store, response) => {\n      user.refetch();\n      const dataInStore = store.readQuery({\n        query: USER\n      });\n      console.log(dataInStore);\n      console.log(response.data);\n      dataInStore.user.push(response.data.user);\n      store.writeQuery({\n        query: USER,\n        data: dataInStore\n      });\n    } // refetchQueries: [{ query: ALL_AUTHORS}, {query: ALL_BOOKS}, {query: USER} ]\n\n  }),\n        _useMutation6 = _slicedToArray(_useMutation5, 1),\n        loginUser = _useMutation6[0];\n\n  const _useMutation7 = useMutation(EDIT_AUTHOR, {\n    onError: handleError,\n    refetchQueries: [{\n      query: ALL_AUTHORS\n    }, {\n      query: ALL_BOOKS\n    }, {\n      query: USER\n    }]\n  }),\n        _useMutation8 = _slicedToArray(_useMutation7, 1),\n        editAuthor = _useMutation8[0];\n\n  if (!token) {\n    return React.createElement(\"div\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 231\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 232\n      },\n      __self: this\n    }, React.createElement(\"button\", {\n      onClick: () => setPage('authors'),\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 233\n      },\n      __self: this\n    }, \"authors\"), React.createElement(\"button\", {\n      onClick: () => setPage('books'),\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 234\n      },\n      __self: this\n    }, \"books\"), React.createElement(\"button\", {\n      onClick: () => setPage('login'),\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 235\n      },\n      __self: this\n    }, \"login\")), errorNotification(), React.createElement(Authors, {\n      authors: authors,\n      editAuthor: editAuthor,\n      show: page === 'authors',\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 239\n      },\n      __self: this\n    }), React.createElement(Books, {\n      books: books,\n      show: page === 'books',\n      page: page,\n      fax: filteredBooks,\n      filter: genreFilter.g,\n      setGenreFilter: filter => setGenreFilter(filter),\n      user: user,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 245\n      },\n      __self: this\n    }), React.createElement(LoginForm, {\n      login: loginUser,\n      setToken: token => setToken(token),\n      show: page === 'login',\n      refetchUser: () => user.refetch(),\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 255\n      },\n      __self: this\n    }));\n  }\n\n  return React.createElement(\"div\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 268\n    },\n    __self: this\n  }, React.createElement(\"div\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 269\n    },\n    __self: this\n  }, React.createElement(\"button\", {\n    onClick: () => setPage('authors'),\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 270\n    },\n    __self: this\n  }, \"authors\"), React.createElement(\"button\", {\n    onClick: () => setPage('books'),\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 271\n    },\n    __self: this\n  }, \"books\"), React.createElement(\"button\", {\n    onClick: () => setPage('add'),\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 272\n    },\n    __self: this\n  }, \"add book\"), React.createElement(\"button\", {\n    onClick: () => {\n      setPage('recommendations');\n      setGenreFilter({\n        g: user.data.me.favorite\n      });\n    },\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 273\n    },\n    __self: this\n  }, \"recommendations\"), React.createElement(\"button\", {\n    onClick: () => logout(),\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 278\n    },\n    __self: this\n  }, \"logout\")), errorMessage && React.createElement(\"div\", {\n    style: {\n      color: 'red'\n    },\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 283\n    },\n    __self: this\n  }, errorMessage), React.createElement(Authors, {\n    authors: authors,\n    editAuthor: editAuthor,\n    show: page === 'authors',\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 288\n    },\n    __self: this\n  }), React.createElement(Books, {\n    books: books,\n    fax: filteredBooks,\n    filter: genreFilter.g,\n    page: page,\n    setGenreFilter: filter => setGenreFilter(filter),\n    show: page === 'books' || page === 'recommendations',\n    makeFavorite: makeFavorite,\n    user: user,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 294\n    },\n    __self: this\n  }), React.createElement(NewBook, {\n    addBook: addBook,\n    refetchBooks: () => books.refetch(),\n    refetchFilteredBooks: () => filteredBooks.refetch(),\n    show: page === 'add',\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 306\n    },\n    __self: this\n  }));\n};\n\nexport default App;","map":{"version":3,"sources":["C:/Users/derek/webdev/HelsinkiFullStack/part8/library-frontend/src/App.js"],"names":["React","useState","Authors","Books","NewBook","LoginForm","useQuery","useMutation","useSubscription","useApolloClient","gql","ALL_AUTHORS","USER","BOOK_ADDED","ALL_BOOKS","BOOKS_BY_GENRE","CREATE_BOOK","LOGIN","EDIT_AUTHOR","MAKE_FAVORITE","App","page","setPage","errorMessage","setErrorMessage","token","setToken","g","genreFilter","setGenreFilter","authors","books","user","filteredBooks","variables","genre","notify","message","setTimeout","client","updateCacheWith","addedBook","includedIn","set","object","map","p","id","includes","dInStoreAll","readQuery","query","dInStoreFiltered","console","log","allBooks","push","writeQuery","data","onSubscriptionData","subscriptionData","bookAdded","title","handleError","error","graphQLErrors","logout","localStorage","clear","resetStore","errorNotification","color","onError","update","store","response","addPerson","addBook","refetchQueries","makeFavorite","refetch","dataInStore","loginUser","editAuthor","filter","me","favorite"],"mappings":"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","sourcesContent":["import React, { useState } from 'react'\r\nimport Authors from './components/Authors'\r\nimport Books from './components/Books'\r\nimport NewBook from './components/NewBook'\r\nimport LoginForm from './components/LoginForm'\r\nimport { useQuery, useMutation, useSubscription, useApolloClient } from 'react-apollo'\r\nimport { gql } from 'apollo-boost'\r\n\r\nconst ALL_AUTHORS = gql`\r\n{\r\n  allAuthors{\r\n    name\r\n    born\r\n    bookCount\r\n  }\r\n}\r\n`\r\n\r\nconst USER = gql`\r\nquery {\r\n  me {\r\n    username\r\n    favorite\r\n  }\r\n}\r\n`\r\n\r\nconst BOOK_ADDED = gql`\r\n  subscription {\r\n    bookAdded{\r\n      title\r\n      author {\r\n        name\r\n        born\r\n      }\r\n      published\r\n      genres\r\n      id\r\n    }\r\n  }\r\n`\r\n\r\nconst ALL_BOOKS = gql`\r\n{\r\n  allBooks {\r\n    title\r\n    author {\r\n      name\r\n      born\r\n    }\r\n    published\r\n    genres\r\n    id\r\n  }\r\n}\r\n`\r\nconst BOOKS_BY_GENRE = gql`\r\n  query genreBooks($genre: String!) {\r\n  allBooks(genre: $genre) {\r\n    title\r\n    author {\r\n      name\r\n      born\r\n    }\r\n    published\r\n    genres\r\n    id\r\n  }\r\n}\r\n\r\n`\r\n\r\nconst CREATE_BOOK = gql`\r\n  mutation createBook($title: String!, $publishedInt: Int!, $author: String!, $genres: [String!]!) {\r\n    addBook(\r\n      title: $title,\r\n      published: $publishedInt,\r\n      author: $author,\r\n      genres: $genres\r\n    ) {\r\n      title\r\n      published\r\n      id\r\n      author {\r\n        name\r\n        born\r\n      }\r\n      genres\r\n    }\r\n  }\r\n`\r\nconst LOGIN = gql`\r\n  mutation login($username: String!, $password: String!){\r\n    login(username: $username, password: $password){\r\n      value\r\n    }\r\n\r\n  }\r\n`\r\n\r\nconst EDIT_AUTHOR = gql`\r\n  mutation editAuthor($name: String!, $born: Int!) {\r\n    editAuthor(name: $name, setBornTo: $born) {\r\n      name\r\n      born\r\n      id\r\n      bookCount\r\n    }\r\n  }\r\n`\r\nconst MAKE_FAVORITE = gql`\r\n  mutation addFavorite($favorite: String!) {\r\n    addFavorite(favorite: $favorite) {\r\n      username\r\n      favorite\r\n    }\r\n  }\r\n`\r\n\r\nconst App = () => {\r\n  const [page, setPage] = useState('authors')\r\n  const [errorMessage, setErrorMessage] = useState(null)\r\n  const [token, setToken] = useState(null)\r\n  const [genreFilter, setGenreFilter] = useState({g: \"\"})\r\n  const authors = useQuery(ALL_AUTHORS)\r\n  const books = useQuery(ALL_BOOKS)\r\n  const user = useQuery(USER)\r\n  \r\n  const filteredBooks = useQuery(BOOKS_BY_GENRE, {\r\n    variables: {genre: genreFilter.g}\r\n  })\r\n\r\n\r\n  const notify = (message) => {\r\n    setErrorMessage(message)\r\n    setTimeout(() => {\r\n      setErrorMessage(null)\r\n    }, 10000)\r\n  }\r\n\r\n  const client = useApolloClient()\r\n\r\n  const updateCacheWith = (addedBook) => {\r\n    const includedIn = (set, object) => set.map(p => p.id).includes(object.id)  \r\n\r\n    const dInStoreAll = client.readQuery({ query: ALL_BOOKS })\r\n    \r\n    const dInStoreFiltered = client.readQuery({ query: BOOKS_BY_GENRE,\r\n      variables: {genre: \"\"} })\r\n\r\n    console.log(dInStoreAll.allBooks)\r\n    if (!includedIn(dInStoreAll.allBooks, addedBook)) {\r\n      console.log(dInStoreAll.allBooks)\r\n      dInStoreAll.allBooks.push(addedBook)\r\n      dInStoreFiltered.allBooks.push(addedBook)\r\n      client.writeQuery({\r\n        query: ALL_BOOKS,\r\n        data: dInStoreAll\r\n      })\r\n      client.writeQuery({\r\n        query: BOOKS_BY_GENRE,\r\n        data: dInStoreFiltered\r\n      })\r\n    }   \r\n  }\r\n\r\n\r\n  useSubscription(BOOK_ADDED, {\r\n    onSubscriptionData: ({ subscriptionData }) => {\r\n      const addedBook = subscriptionData.data.bookAdded\r\n      notify(`${addedBook.title} added`)\r\n      updateCacheWith(addedBook)\r\n    }\r\n  })\r\n\r\n  const handleError = (error) => {\r\n    setErrorMessage(error.graphQLErrors[0].message)\r\n    setTimeout(() => {\r\n      setErrorMessage(null)\r\n    }, 10000)\r\n  }\r\n\r\n  const logout = () => {\r\n    setToken(null)\r\n    localStorage.clear()\r\n    client.resetStore()\r\n  }\r\n\r\n\r\n  const errorNotification = () => errorMessage &&\r\n  <div style={{ color: 'red' }}>\r\n    {errorMessage}\r\n  </div>\r\n\r\n  const [addBook] = useMutation(CREATE_BOOK, {\r\n    onError: handleError,\r\n    update: (store, response) => {\r\n      updateCacheWith(response.data.addPerson)\r\n    }\r\n  })\r\n\r\n  const [makeFavorite] = useMutation(MAKE_FAVORITE, {\r\n    onError: handleError,\r\n    refetchQueries: [{ query: ALL_AUTHORS}, {query: ALL_BOOKS}, {query: USER}]\r\n  })\r\n\r\n  const [loginUser] = useMutation(LOGIN, {\r\n    onError: handleError,\r\n    update: (store, response) => {\r\n      user.refetch()\r\n      const dataInStore = store.readQuery({query: USER})\r\n      console.log(dataInStore)\r\n      console.log(response.data)\r\n      dataInStore.user.push(response.data.user)\r\n      store.writeQuery({\r\n        query: USER,\r\n        data: dataInStore\r\n      })\r\n    }\r\n    // refetchQueries: [{ query: ALL_AUTHORS}, {query: ALL_BOOKS}, {query: USER} ]\r\n  })\r\n\r\n  const [editAuthor] = useMutation(EDIT_AUTHOR, {\r\n    onError: handleError,\r\n    refetchQueries: [{ query: ALL_AUTHORS}, {query: ALL_BOOKS}, {query: USER}]\r\n\r\n  })\r\n\r\n    if (!token) {\r\n    return ( \r\n      <div>\r\n        <div>\r\n        <button onClick={() => setPage('authors')}>authors</button>\r\n        <button onClick={() => setPage('books')}>books</button>\r\n        <button onClick={() => setPage('login')}>login</button>\r\n      </div>\r\n        {errorNotification()}\r\n\r\n      <Authors\r\n        authors = {authors}\r\n        editAuthor = { editAuthor } \r\n        show={page === 'authors'}\r\n      />\r\n\r\n      <Books\r\n        books = { books }\r\n        show = {page === 'books'}\r\n        page = {page}\r\n        fax = { filteredBooks }\r\n        filter = {genreFilter.g}\r\n        setGenreFilter = {(filter) => setGenreFilter(filter)}\r\n        user = {user}\r\n      />\r\n\r\n      <LoginForm \r\n          login = {loginUser}\r\n          setToken = {(token) => setToken(token)}\r\n          show={page === 'login'}\r\n          refetchUser = {() => user.refetch()}\r\n          />\r\n      </div>\r\n    )\r\n  }\r\n\r\n\r\n\r\n  return (\r\n    <div>\r\n      <div>\r\n        <button onClick={() => setPage('authors')}>authors</button>\r\n        <button onClick={() => setPage('books')}>books</button>\r\n        <button onClick={() => setPage('add')}>add book</button>\r\n        <button onClick={() => {\r\n          setPage('recommendations')\r\n          setGenreFilter({g: user.data.me.favorite})\r\n        }\r\n          }>recommendations</button>\r\n        <button onClick={() => logout()}>logout</button>\r\n\r\n      </div>\r\n\r\n      {errorMessage &&\r\n      <div style = {{color: 'red'}}>\r\n        {errorMessage}\r\n      </div>\r\n      }\r\n\r\n      <Authors\r\n        authors = {authors}\r\n        editAuthor = { editAuthor } \r\n        show={page === 'authors'}\r\n      />\r\n\r\n      <Books\r\n        books = { books }\r\n        fax = { filteredBooks }\r\n        filter = {genreFilter.g}\r\n        page = {page}\r\n        setGenreFilter = {(filter) => setGenreFilter(filter)}\r\n        show= {page === 'books' || page === 'recommendations'}\r\n        makeFavorite = { makeFavorite }\r\n        user = {user}\r\n\r\n      />\r\n\r\n      <NewBook\r\n        addBook = { addBook } \r\n        refetchBooks = {() => books.refetch()}\r\n        refetchFilteredBooks ={() => filteredBooks.refetch()}\r\n        show={page === 'add'}\r\n      />\r\n\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default App"]},"metadata":{},"sourceType":"module"}